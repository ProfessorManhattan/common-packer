---
version: '3'

vars:
  TEMPLATE_FILE:
    sh: if [ ! -z "{{.CLI_ARGS}}" ]; then echo "{{.CLI_ARGS}}"; else echo template.json; fi

tasks:
  all:
    deps:
      - :software:kvm
      - :software:packer
      - :software:parallels
      - :software:virtualbox
      - :software:vmware
    desc: Build Packer images for all platforms (default setting uses `template.json`)
    summary: |
      $ Build Packer images for all virtualization platforms

      This task begins by removing cached files that may interfere with the Packer build
      process. It then runs `packer build template.json` if no arguments are passed. This
      command will build Packer images for all the virtualization platforms specified in
      the template file. The template file may include instructions for the following
      virtualization platforms (and it is possible that it includes other ones that are
      not listed below):
        * Hyper-V   * Parallels    * VMWare
        * KVM       * VirtualBox

      If you would like to build machine images with another template then you can pass the
      template's file name as a parameter (see example below).

      Example:
      > task packer:all

      Example using a template file named `another_template.json`:
      > task packer:all -- another_template.json
    cmds:
      - task: prepare-packer
      - packer build {{.TEMPLATE_FILE}}

  parallels:
    deps:
      - :software:packer
      - :software:parallels
    desc: Build a Packer image for Parallels
    summary: |
      $ Build a Packer image for Parallels

      This task will build a machine image intended to be used by Parallels. Parallels
      is only available for macOS. By default, this task assumes the template file is
      titled `template.json` and that the file is in the root of the project. If you
      would like to use another template file then you can do so by passing the file
      name as a parameter (see example below).

      Example:
      > task packer:parallels

      Example using a template file named `another_template.json`
      > task packer:parallels -- another_template.json
    cmds:
      - task: prepare-packer
      - packer build -only=parallels-iso {{.TEMPLATE_FILE}}

  virtualbox:
    deps:
      - :software:packer
      - :software:virtualbox
    desc: Build a Packer image for VirtualBox
    summary: |
      $ Build a Packer image for VirtualBox

      This task will build a machine image intended to be used by VirtualBox. By
      default, this task assumes the template file is titled `template.json` and
      that the file is in the root of the project. If you would like to use another
      template file then you can do so by passing the file name as a parameter
      (see example below).

      Example:
      > task packer:virtualbox

      Example using a template file named `another_template.json`
      > task packer:virtualbox -- another_template.json
    cmds:
      - task: prepare-packer
      - packer build -only=virtualbox-iso {{.TEMPLATE_FILE}}

  vmware:
    deps:
      - :software:packer
      - :software:vmware
    desc: Build a Packer image for VMWare
    summary: |
      $ Build a Packer image for VMWare

      This task will build a machine image intended to be used by VMWare. The image
      build can be used by either VMWare Workstation (i.e. Linux, Windows) or by
      VMWare Fusion (i.e. macOS). By default, this task assumes the template file is
      titled `template.json` and that the file is in the root of the project. If you
      would like to use another template file then you can do so by passing the file
      name as a parameter (see example below).

      Example:
      > task packer:vmware

      Example using a template file named `another_template.json`
      > task packer:vmware -- another_template.json
    cmds:
      - task: prepare-packer
      - packer build -only=vmware-iso {{.TEMPLATE_FILE}}
