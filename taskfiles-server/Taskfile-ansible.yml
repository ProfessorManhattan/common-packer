---
version: '3'

tasks:
  ansibler-compatibility-chart:
    deps:
      - :common:python-requirements
      - :software:jq
    env:
      TMP:
        sh: mktemp
    cmds:
      - ansibler --generate-compatibility-chart --molecule-results-dir molecule/.results --json-file .variables.json
      - |
        MATRIX_JSON=$(jq -r '.blueprint.compatibility_matrix' package.ansibler.json)
        jq --arg matrix "$MATRIX_JSON" '.compatibility_matrix = ($matrix | fromjson)' .variables.json > "$TMP"
        mv "$TMP" .variables.json
    sources:
      - molecule/.results/*.txt

  ansibler-role-dependencies:
    deps:
      - :common:python-requirements
    cmds:
      - ansibler --role-dependencies --json-file .variables.json
    sources:
      - requirements.yml

  ansibler-tasks:
    deps:
      - ansibler-role-dependencies
      - collection-dependencies

  ansibler:
    deps:
      - :common:python-requirements
    cmds:
      - task: ansibler-compatibility-chart
      - task: ansibler-tasks
    preconditions:
      - sh: 'type ansibler &> /dev/null'
        msg: '`ansibler` is not installed globally. Install all the requirements by running `task common:requirements`.'
    status:
      - true

  collection-dependencies:
    deps:
      - :software:jq
      - :software:yq
    env:
      COLLECTIONS:
        sh: yq eval -j '.collections' requirements.yml
      TMP:
        sh: mktemp
    cmds:
      - COLLECTION_DEPS="$(jq --arg collections "$COLLECTIONS" '.collection_dependencies = ($collections | fromjson)
        | "<b><a href=\"" + .collection_dependencies[].source + "/" + (.collection_dependencies[].name
        | split(".") | join("/")) + "\" title=\"" + .collection_dependencies[].name +
        " collection on Ansible Galaxy\" target=\"blank\">" + .collection_dependencies[].name
        + "</a></b>"' -r  .variables.json | jq --raw-input --slurp 'split("\n") | .[0:((. | length) - 1)]')"
        && jq --arg collections "$COLLECTION_DEPS" '.collection_dependencies = ($collections | fromjson)' .variables.json > "$TMP"
      - mv "$TMP" .variables.json
    sources:
      - .variables.json
      - requirements.yml

  collection-dependencies-markdown:
    deps:
      - :software:jq
    vars:
      MULTIPLE_COLLECTIONS_TEXT: ### Galaxy Collections\n\nThis role is dependent on multiple Ansible Galaxy
        collections. The collections along with a links to their source are listed below.\n\n{{collection_dependencies}}
      SINGLE_COLLECTION_TEXT: ### Galaxy Collection\n\nThis role is dependent on the following Ansible Galaxy
        collection:\n\n
    env:
      COLLECTION_LENGTH:
        sh: jq -r '.collection_dependencies | length' .variables.json
    cmds:
      - mkdir -p .autodoc
      - |
        if [ "$COLLECTION_LENGTH" == '0' ]; then
          echo "" > .autodoc/collection_dependencies.md
        elif [ "$COLLECTION_LENGTH" == '1' ]; then
          echo "{{.SINGLE_COLLECTION_TEXT}}" > .autodoc/collection_dependencies.md
        else
          echo "{{.MULTIPLE_COLLECTIONS_TEXT}}" > .autodoc/collection_dependencies.md
        fi
    sources:
      - .autodoc/collection_dependencies.md
      - .variables.json
